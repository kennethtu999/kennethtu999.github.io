<!DOCTYPE html>
<html>
<head>
	<title>Canvas FileUpload Preview</title>
	<style>
		body {
			padding: 50px;
			font: 16px Helvetica;
		}

		.resultImageWrapper {
			display: none;
			margin-top: 50px;
			text-align: center;
		}

		#resultImage {
			box-shadow: rgba(0,0,0,0.4) 0 2px 5px;
		}
	</style>
</head>
<body>

<div>
	<h4>Step1 上傳圖檔</h4>
	<div>
		<input type="file" id="imageFile"/>
	</div>

	<h4>Step2 取得圖檔內容</h4>
	<div>
		<button id="getimg" type="button">取得圖檔內容供上傳</button>
		<textarea id="base64content" rows="7" cols="100">

		</textarea>
	</div>

	<h4>Step3 線上轉換</h4>
	<div>
		<a href="https://codebeautify.org/base64-to-image-converter" target="_blank">線上轉換</a>
	</div>

<div class="resultImageWrapper">
	<img src="" alt="" id="resultImage" />
</div>

<script src="//code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
	$(function(){
		handleDrop = function(files){
			var file = files[0]; // Multiple files can be dropped. Lets only deal with the "first" one.

			if (file.type.match('image.*')) {
				resizeImage(file, 1000, function(result) {
					$('#resultImage').attr('src', result);
					$('.resultImageWrapper').show();
				});
			} else {
				alert("That file wasn't an image.");
			}
		};

		$('#imageFile').on('change', function(event) {
			handleDrop(event.target.files);
		});

		$('#getimg').on('click', function(event) {
			var content = $("#resultImage").attr("src");
			content = content.replace(/^.*,/,'');
			$("#base64content").val(content);
		});

		resizeImage = function(file, size, callback) {
			var fileTracker = new FileReader;
			fileTracker.onload = function() {
				var image = new Image();
				image.onload = function(){
					var canvas = document.createElement("canvas");
					/*
					if(image.height > size) {
						image.width *= size / image.height;
						image.height = size;
					}
					*/
					if(image.width > size) {
						image.height *= size / image.width;
						image.width = size;
					}
					var ctx = canvas.getContext("2d");
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					canvas.width = image.width;
					canvas.height = image.height;
					ctx.drawImage(image, 0, 0, image.width, image.height);
					callback(canvas.toDataURL("image/png"));
				};
				image.src = this.result;
			}

			fileTracker.readAsDataURL(file);

			fileTracker.onabort = function() {
				alert("The upload was aborted.");
			}

			fileTracker.onerror = function() {
				alert("An error occured while reading the file.");
			}
		};
	});


</script>

</body>
</html>